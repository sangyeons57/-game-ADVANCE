<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>boxgame</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
</head>

<body>
<script type = "text/javascript">

    var config = {
        type: Phaser.AUTO,
        width: 900,
        height: 650,
        physics:{
            default: 'arcade',
            arcade: {
                debug: false
            }
        },
        scene:{
            preload: preload,
            create: create,
            update: update
        }
    }

    var game = new Phaser.Game(config)

    function preload(){
        this.load.image('background', 'assets/background.PNG')
        this.load.image('playerB', 'assets/player.PNG')
        this.load.image('ground1', 'assets/ground1.PNG')
        this.load.image('lastwall', 'assets/lastwall.PNG')
        this.load.image('gun', 'assets/gun1.PNG')

        this.load.image('enemy1', 'assets/enemy1.PNG')
    }
let jump = 0

let Player
let PlayerCondition
let Ground


let ispointerdown

let shotiterval

let playerlife = 100


let shoting


let enemy_group
let shot_group

    function create(){
        //group 정의
        enemy_group = this.add.group()
        shot_group = this.add.group()

        Ground = this.physics.add.staticGroup()


        //background 설정
        this.add.image(800,100, 'background').setScale(7)
        //player. 설정
        Player = this.physics.add.sprite(100,600,'playerB')

        Player.body.setGravityY(1000)
        Player.setCollideWorldBounds(false);

        //camera 설정
        this.cameras.main.setBounds(0,0,20000,1200)
        this.cameras.main.startFollow(Player, true, 0.11, 0.11)



        // 총 설정


        Ground .create(0,700, "lastwall").setScale(5).refreshBody()
        Ground.create(700,1500,"ground1").setScale(5).refreshBody()

        enemy1(300,300,this)
        enemy1(400,300,this)

        // 바닥 물리 설정
        this.physics.add.collider(Player,Ground)

        this.input.keyboard.on('keydown', (event)=> {
            console.log(event.code)
            if (event.code === "KeyW" && jump < 2){
                jump = jump + 1
                Player.setVelocityY(-600)
            } else if (event.code === "KeyD"){
                Player.setVelocityX(200)
            } else if (event.code === "KeyA"){
                Player.setVelocityX(-200)
            }
        })

        //공격
        this.input.on('pointerdown', () =>{
            shoting = true
        })

        this.input.on('pointerup', () =>{
            shoting = false
        })

        shoting_bullet(this,Ground)
    }

    function update(){
        PlayerCondition_isTouchingGround = Player.body.touching.down
        PlayerCondition_isTouchingEnemy = false


        if(Player.body.touching.down){
            jump = 0
        }

        if (playerlife < 0){
            let endmsg = this.add.text(280, 250, 'score: 0', { fontSize: '150px', fill: 'red'})
            endmsg.setText("Game Over")
        }
    }

    function shoting_bullet(t,G){
        setInterval(()=>{
            if (shoting === true){
                shot(t,G)
            }
        },190)

    }
    
    //atan 각도구하기 현재 미구현 총 발사 함수
    function shot(t,G){
        const mx = game.input.mousePointer.x
        const my = game.input.mousePointer.y
        const px = Player.x
        const py = Player.y

        let bullet = t.physics.add.sprite(px,py, 'gun').setScale(0.7)
        shot_group.add(bullet)
        bullet.body.setGravityY(0)
        bullet.body.setGravityX(0)
        console.log(Player)


        t.physics.add.overlap(G,bullet,()=>(shotDestroy(bullet,shotinterval))) 
        // 총=> 적 반응 설정
        t.physics.add.overlap(enemy_group,shot_group,()=>{hit_enemy(bullet,shotinterval)},null,t)

        let shotinterval = setInterval(()=>{
            if (mx - px > 0  ){
                bullet.setVelocityX(500,500)
            } else if (mx - px <0 ){
                bullet.setVelocityX(-500)
            } else {
                bullet.setVelocityX(500)

            }

            if((bullet.x - px) > 600 ||  (bullet.x - px) < -600){
                shotDestroy(bullet,shotinterval)
            }
        },1)
        // Gun.children.entries[Gun.children.entries.length-1].angle = 10
    }

    function hit_enemy(bullet,shotinterval){
        shotDestroy(bullet,shotinterval)
        bullet.destroy()
    }

    function shotDestroy(bullet, shotinterval){
        clearInterval( shotinterval)
        bullet.destroy()
    }

    function enemy1(x,y,t){
        let enemy = t.physics.add.sprite(x,y,'enemy1')

        enemy.ed = 0

        enemy_group.add( enemy)
        enemy.body.setGravityY(900)
        enemy.setBounce(0.3)
        t.physics.add.collider(enemy,Ground)
        t.physics.add.overlap(Player,enemy,damage,null,t)


        t.physics.add.overlap(enemy_group,shot_group,()=>{enemy.ed +=1})
        console.log(enemy_group)

        let interval = setInterval(()=>{
            DistanceToPlayer = Math.sqrt((enemy.x - Player.x) ** 2 + (enemy.y - Player.y)** 2  )
            if(DistanceToPlayer < 900){

                if (DistanceToPlayer < 30){
                    damage(15)
                    enemy.destroy()
                    clearInterval(interval)
                } else if (Player.x-enemy.x>0){
                    enemy.setVelocityX(80)
                } else{
                    enemy.setVelocityX(-80)
                }

                if (enemy.ed > 6 ){
                    enemy.destroy()
                    clearInterval(interval)
                }

            }
        }, 10)

        //enemy1dict[`enemy1_${enemy1num}`] = enemy
    }



    function damage(num){
        playerlife = playerlife - num
        
    }

</script>

</body>
</html>